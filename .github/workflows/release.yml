name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build, Sign, Notarize and Release
    runs-on: macos-15
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 26.0.1
        run: sudo xcode-select -s /Applications/Xcode_26.0.1.app/Contents/Developer

      - name: Show Build Environment
        run: |
          xcodebuild -version
          swift --version
          echo "macOS: $(sw_vers -productVersion)"
          echo "Tag: ${{ github.ref_name }}"

      - name: Import Code Signing Certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.DEVELOPER_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(uuidgen)

          echo "Creating temporary keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "Importing code signing certificate..."
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign

          # Allow codesign and xcodebuild to access keychain without prompt
          security set-key-partition-list -S apple-tool:,apple:,codesign:,xcodebuild: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Set as default keychain
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"

          # Clean up certificate file
          rm -f certificate.p12

          echo "âœ… Code signing certificate imported successfully"

      - name: Build Release (Signed)
        run: |
          echo "Building signed release..."
          xcodebuild build \
            -project "Claude Usage.xcodeproj" \
            -scheme "Claude Usage" \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="${{ secrets.TEAM_ID }}" \
            CODE_SIGN_STYLE=Automatic \
            ENABLE_HARDENED_RUNTIME=YES

          echo "âœ… Build completed successfully"

      - name: Verify Code Signature
        run: |
          APP_PATH="build/Build/Products/Release/Claude Usage.app"

          echo "Verifying code signature..."
          # Verify signature is valid
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

          # Display signature details
          echo ""
          echo "Code signature details:"
          codesign -dv --verbose=4 "$APP_PATH" 2>&1

          # Check Gatekeeper assessment
          echo ""
          echo "Gatekeeper assessment:"
          spctl --assess --type execute --verbose "$APP_PATH" 2>&1 || true

          echo "âœ… Code signature verified"

      - name: Notarize App
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          APP_PATH="build/Build/Products/Release/Claude Usage.app"

          echo "Creating ZIP for notarization..."
          ditto -c -k --keepParent "$APP_PATH" "notarization.zip"

          echo "Submitting app for notarization..."
          echo "This may take 5-15 minutes..."
          xcrun notarytool submit "notarization.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$TEAM_ID" \
            --wait \
            --timeout 30m

          echo ""
          echo "Notarization successful! Stapling ticket to app..."
          xcrun stapler staple "$APP_PATH"

          # Verify stapling
          echo ""
          echo "Verifying stapled notarization ticket..."
          xcrun stapler validate "$APP_PATH"

          # Clean up
          rm -f notarization.zip

          echo "âœ… App notarized and stapled successfully!"

      - name: Create Release Artifact
        run: |
          # Create artifacts directory
          mkdir -p release

          # Copy app bundle (preserving attributes and signatures)
          echo "Copying signed and notarized app bundle..."
          cp -pR "build/Build/Products/Release/Claude Usage.app" release/

          # Create ZIP archive using ditto (preserves code signatures and notarization)
          echo "Creating release ZIP..."
          cd release
          ditto -c -k --keepParent "Claude Usage.app" "Claude-Usage.zip"

          # Generate SHA256 checksum
          shasum -a 256 "Claude-Usage.zip" > "Claude-Usage.zip.sha256"

          # Display checksum for logs
          echo ""
          echo "SHA256 Checksum:"
          cat "Claude-Usage.zip.sha256"

          echo "âœ… Release artifact created"

      - name: Extract Release Notes from CHANGELOG
        id: changelog_notes
        continue-on-error: true
        run: |
          # Extract version from tag
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          echo "Extracting release notes for version $VERSION from CHANGELOG.md"

          # Extract the section for this version from CHANGELOG.md
          # This extracts everything between ## [$VERSION] and the next ## or ---
          awk "/## \[$VERSION\]/{flag=1; next} /^---$|^## \[/{flag=0} flag" CHANGELOG.md > release-notes.md

          # Remove trailing empty lines
          sed -i.bak '/^$/d' release-notes.md 2>/dev/null || sed -i '' -e '/^$/d' release-notes.md

          # Check if we got content
          if [ ! -s release-notes.md ]; then
            echo "No release notes found in CHANGELOG.md for version $VERSION"
            echo "changelog_extracted=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Extracted release notes:"
          cat release-notes.md

          echo "changelog_extracted=true" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          draft: false
          body_path: ${{ steps.changelog_notes.outputs.changelog_extracted == 'true' && 'release-notes.md' || '' }}
          generate_release_notes: ${{ steps.changelog_notes.outputs.changelog_extracted != 'true' }}
          files: |
            release/Claude-Usage.zip
            release/Claude-Usage.zip.sha256
        env:
          # Use PAT instead of GITHUB_TOKEN to trigger downstream workflows
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: Release Summary
        run: |
          echo "ðŸŽ‰ Release ${{ github.ref_name }} created successfully!"
          echo ""
          echo "âœ… App signed with Developer ID Application certificate"
          echo "âœ… App notarized by Apple"
          echo "âœ… Notarization ticket stapled to app"
          echo "âœ… Release published to GitHub"
          echo ""
          echo "Next steps:"
          echo "  - Appcast generation workflow will trigger automatically"
          echo "  - Homebrew cask will update automatically"
          echo "  - Users with automatic updates enabled will be notified"
